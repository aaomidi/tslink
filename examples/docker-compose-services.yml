# Example: Load-balanced backends with Tailscale Services
#
# Tailscale Services provide a stable VIP that load-balances across backends.
# Each backend registers itself with the service automatically.
#
# Prerequisites:
#   1. Create a service named "my-app" in Tailscale admin console:
#      https://login.tailscale.com/admin/services
#   2. Use a tag-based auth key (required for services)
#
# Usage:
#   export TS_AUTHKEY=tskey-auth-xxx
#   docker-compose -f docker-compose-services.yml up -d
#   docker-compose -f docker-compose-services.yml up -d --scale backend=3
#
# Access via the TailVIP assigned in the admin console.
#
# Note: Use :main-arm64 or :main-amd64 depending on your architecture

networks:
  tailnet:
    driver: ghcr.io/aaomidi/tslink:main-arm64
    driver_opts:
      tslink.authkey: ${TS_AUTHKEY}

services:
  backend:
    image: nginx:alpine
    networks:
      - tailnet
    labels:
      tslink.service: "svc:my-app"
      tslink.serve.443: "https:80"  # HTTPS on 443 -> container port 80
