# Example: Two services communicating over Tailscale
# Each container gets its own Tailscale identity and can reach the other
#
# Usage:
#   export TS_AUTHKEY=tskey-auth-xxx
#   docker-compose up -d
#
# Note: Use :latest-arm64 or :latest-amd64 depending on your system

networks:
  tailnet:
    driver: ghcr.io/aaomidi/tslink:latest-arm64
    driver_opts:
      ts.authkey: ${TS_AUTHKEY}

services:
  # Simple web server
  web:
    image: nginx:alpine
    networks:
      - tailnet
    labels:
      ts.hostname: "web-server"
    # No ports exposed - accessible only via Tailscale!

  # Client that can reach the web server via Tailscale
  client:
    image: alpine
    networks:
      - tailnet
    labels:
      ts.hostname: "test-client"
    command: |
      sh -c "
        echo 'Waiting for Tailscale to connect...'
        sleep 20
        echo 'My IP info:'
        ip addr | grep inet
        echo ''
        echo 'Testing internet access:'
        ping -c 2 8.8.8.8
        echo ''
        echo 'The web server should be reachable at its Tailscale IP or via MagicDNS:'
        echo '  curl http://web-server'
        echo ''
        sleep 300
      "
    depends_on:
      - web
