# Example: Tailscale Services with HTTPS
#
# This example demonstrates HTTPS where Tailscale:
# - Terminates TLS on port 443
# - Acts as an HTTP reverse proxy to the container's port 80
#
# Prerequisites:
# 1. Create a service named "helloworld-tls" in Tailscale admin console
#    (https://login.tailscale.com/admin/services)
# 2. Set TS_AUTHKEY to a tag-based auth key (tags are required for services)
#
# Usage:
#   export TS_AUTHKEY=tskey-auth-xxx
#   docker-compose -f docker-compose-tls.yml up -d
#
# The service will be accessible via HTTPS at the TailVIP assigned in the
# admin console. Tailscale terminates TLS and forwards to the container's
# plain HTTP port 80.
#
# Note: Use :latest-arm64 or :latest-amd64 depending on your system

networks:
  tailnet:
    driver: ghcr.io/aaomidi/tslink:latest-arm64
    driver_opts:
      ts.authkey: ${TS_AUTHKEY}

services:
  # Backend with TLS termination
  # Tailscale handles TLS on port 443, forwards to container port 80
  web:
    image: nginx:alpine
    networks:
      - tailnet
    labels:
      ts.hostname: "hello-tls"
      ts.service: "svc:helloworld-tls"
      # HTTPS (L7): Tailscale terminates TLS and reverse-proxies HTTP to localhost:80
      # This makes the service accessible via https://service-name.tailnet.ts.net/
      ts.serve.443: "https:80"

  # Database example: TLS-terminated TCP for databases
  # Use tls-terminated-tcp for L4 services (databases, redis, etc.)
  # db:
  #   image: postgres:alpine
  #   networks:
  #     - tailnet
  #   labels:
  #     ts.hostname: "postgres-backend"
  #     ts.service: "svc:database"
  #     # For TLS on database connections:
  #     # ts.serve.5432: "tls-terminated-tcp:5432"
  #     # For plain TCP (no TLS):
  #     ts.serve.5432: "tcp:5432"

  # Client to test connectivity
  client:
    image: alpine
    networks:
      - tailnet
    labels:
      ts.hostname: "tls-test-client"
    command: |
      sh -c "
        echo 'Waiting for Tailscale to connect...'
        sleep 30
        echo ''
        echo 'My Tailscale IP:'
        ip addr show | grep 100.
        echo ''
        echo 'Test the TLS service from any Tailscale client:'
        echo '  curl https://<service-tailvip>'
        echo ''
        echo 'Sleeping to keep container alive...'
        sleep 3600
      "
    depends_on:
      - web
